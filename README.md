# Грузовики

В данном проекте полная реализация задачи о перевозке железной руды на Урале.
Репозиторий будет постоянно обновляться.

## Общая информация

### Разделение задания на подзадачи

1. Реализация SystemFile;
2. Реализация программы, исполняющей роль одного самосвала (далее - Самосвал);
3. Реализация программы, исполняющей роль регулировщика с одной стороны моста (далее - Регулироввщик);
4. Реализация программы, отвечающей за запуск потоков регулировщиков и самосвалов (далее - Инициализатор).

### Используемые инструменты

1. Очереди сообщений для сообщения регулировщикам о прибытии самосвала;
2. Семафоры для передачи самосвалам разрешения на проезд и сигнала о завершении работы.

### Возможные события

1. У моста нет самосвалов;
2. С одной стороны моста нет самосвалов;
3. Самосвалы есть по обе стороны моста;
4. Прибыл самосвал недопустимого веса.

### Упрощенная задача

1. Все самосвалы одного веса;
2. Регулировщик допускает на мосту наличие только одного самосвала.

### Распределение между участниками группы

1. Шоислом;
2. Вальтер;
3. Глеб;
4. Аян.

## Межпроцессное взаимодействие

### 1. Введение в методы взаимодействия в данной задаче
1. #### Очереди сообщений
   1. Самосвал - Регулировщик:
      * Регулировщик выступает выступает в качестве сервера, Самосвал - в качестве клиента;
      * Самосвал посылает сообщение Регулировщику, расположенному с ним по одну сторону моста, после подъезда к мосту, а Регулировщик принимает его.
2. #### Семафоры
   1. Самосвал - Регулировщик:
      1. Пропускающий семафор (далее - семафор самосвалов):
         * Регулировщик разрешает Самосвалу проезд по мосту, устанавливая заданное значение семафора;
         * После проезда по мосту Самосвал меняет значение семафора на исходное (исходное значение == 0).
   2. Регулировщик - Регулировщик:
      1. Операционный семафор (далее - семафор регулировщиков):
         * Применяется для определения того, какой Регулировщик руководит движением на мосту в данный момент.
   3. Общие:
      1. Завершающий семафор:
         * Процессы завершают работу, если установлено значение 0.
      2. Семафор количества участников:
         * значение семафора №0 соответствует количеству запущенных процессов;
         * значение семафора №1 соответствует количеству активных регулировщиков.

### 2. Порядок взаимодействия с "соседними" процессами
1. #### Самосвал - Регулировщик
   1. После подъезда к мосту Самосвал посылает соответствующему Регулировщику сообщение по форме ```"Номер Самосвала" "Масса Самосвала"```, а затем ждёт разрешение на проезд от Регулировщика;
   2. Если Регулировщик разрешает Самосвалу движение по мосту, то меняет значение его семафора на 1 (увеличивает на 1);
   3. Самосвал устанавливает значение собственного семафора на 0; 
   4. После выезда с моста Самосвал меняет значение семафора на 1 (добавляет 1) и ждёт, пока Регулировщик не установит значение 0;
   5. Регулировщик меняет значение семафора Самосвала на 0 (уменьшает на 1);
   6. Регулировщик уменьшает значение завершающего семафора на 1;
2. #### Регулировщик - Регулировщик
   1. Для передачи управления движением Регулировщик меняет значение семафора на номер другого регулировщика, а затем ждёт, пока семафор не примет значение, соответствующее его номеру.

### 3. Правила создания ключей семафоров и очередей сообщений
   1. Для получения ключа используем ```ftok(const char *pathname, int proj_id)```;
   2. ```pathname = "transit"```
   3. `proj_id`
      1. `proj_id = 1, 2` для очередей сообщений регулировщиков `mine` и `fabric` соответсвенно;
      2. `proj_id = 3` для семафора регулировщиков;
      3. `prog_id = 4` для семафора завершения;
      4. `proj_id = 5` для семафора количества участников;
      5. `proj_id = 6` для массива семафоров самосвалов.

# Требования к реализации программ (задач)
### 1. Общие требования
   1. Использовать `enum Location` из `initialization.hpp` для определения положения объектов.
   2. Логировать существенные действия самосвалов / регулировщиков (каждое изменение семафоров логировать не нужно).

### 2. Аргументы конструкторов
   1. Самосвал: `Truck(bool init_location, uint8_t number, uint8_t weight, uint8_t speed)`;
   2. Регулировщик: `TrafficController(bool location, uint8_t max_weight, uint8_t max_number_of_trucks`.

### 3. Создание и удаление семафоров / очередей сообщений
   1. Очереди сообщений регулировщиков создают и удаляют только соответствующие регулировщики; гарантируется, что
очереди сообщений существуют с момента запуска самосвалов до сигнала о завершении;
   2. Семафор регулировщиков создаёт первый прибывший регулировщик, а удаляет последний отключившийся;
   3. Семафор самосвалов создаётся первым прибывшим регулировщиков, а удаляется последним отключившимся участником;
   4. Семафор завершения создаётся первым прибывшим регулировщиком, а удаляется последним отключившимся участником;
   5. Семафор количества участников создаётся первым прибывшим регулировщиком, а удаляется последним отключившимся участником.

### 4. Названия файлов
   1. Инициализатор: реализация в файле `initialization.cpp`, логирование в файл `LogInitializator.txt`;
   2. Самосвал: объявление класса `Truck` в файле `truck.hpp`, реализация - в файле, `truck.cpp`, логирование в файл
`LogTruck"номер самосвала".txt`;
   3. Регулировщик: объявление класса `TrafficController` в файле `traffic_controller.hpp`, реализация - в файле
`traffic_controller.cpp`, логирование в файл `LogTrafficController"расположение регулировщика".txt`;
   4. SystemFile: объявление класса `SystemFile` в файле `SystemFile.hpp`, реализация - в файле `SystemFile.cpp`.

### 5. Запуск
   1. Инициализатор: 
      1. Создаёт два объекта класса ```TrafficController``` с различными параметрами (расположение относительно моста,
максимальная допустимая нагрузка на мост, количество самосвалов, которых нужно пропустить),
      а затем вызывает метод `StartProcess` у каждого из объектов;
      2. Создаёт необходимое количество объектов класса `Truck` с различными параметрами (изначальное расположение самосвала относительно моста,
      номер самосвала (0-индексация)), а затем вызывает `StartProcess` у каждого из объектов.
   2. Самосвал (на усмотрение Вальтера):
      1. Добавляет единицу к значению семафора количества участников (0 в массиве).
   3. Регулировщик:
      1. Создаёт семафоры регулировщиком, завершения, количества участников, самосвалов (если возможно);
      2. Собственную очередь сообщений;
      3. Добавляет единицу к значению семафора количества участников (0 и 1 в массиве).

### 6. Завершение
   1. Инициализатор (нужна консультация Овсянниковой);
   2. Самосвал:
      1. Отнимает единицу от значения семафора количества участников (0 в массиве);
      2. (правила создания и удаления семафоров / очередей сообщений).
   3. Регулировщик:
      1. Отнимает единицу от значения семафора количества участников (0 и 1 в массиве);
      2. Устанавливает значение семафора завершение равным 0;
      3. (правила создания и удаления семафоров / очередей сообщений).

# Критерий завершение работы
1. Самосвал завершает работу, если значение завершающего семафора == 0;
2. Регулировщик завершает работу, если по мосту проехало заданное количество самосвалов, либо если значение завершающего
семафора == 0. При завершении работы устанавливает значение завершающего семафора = 0 (если оно уже не было
установлено), если в очереди к семафору стоят самосвалы, то он разрешает им проезд (чтобы у самосвала была возможность
проверить семафор завершения);
3. Инициализатор завершает работу, когда работу завершили все Регулировщики (нужна консультация Овсянниковой).